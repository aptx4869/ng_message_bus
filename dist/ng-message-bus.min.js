/*!Copyright(c) ng-message-bus (//github.com/aptx4869/ng_message_bus) - Licensed under the MIT License */
(function(){"use strict";angular.module("message-bus",[]).factory("MessageBus",["$http","$httpParamSerializerJQLike","$timeout","$document","$q",function(a,b,c,d,e){var f,g,h,i,j,k,l,m,n,o,p;return g=d[0],p=function(){return"xxxxxxxxxxxx4xxxyxxxxxxxxxxxxxxx".replace(/[xy]/g,function(a){var b,c;return b=16*Math.random()|0,c="x"===a?b:3&b|8,c.toString(16)})},m=j=h=void 0,f=e.defer()," webkit ms moz ms".split(" ").forEach(function(a){var b;return b=a+(""===a?"hidden":"Hidden"),void 0!==g[b]?h=b:void 0}),i=function(){return void 0!==h?g[h]:!g.hasFocus},o=function(){return l.alwaysLongPoll||!i()},n=function(a){var b;return b=!1,a?(angular.forEach(a,function(a){return b=!0,angular.forEach(l.callbacks,function(b){var c;if(b.channel===a.channel){b.last_id=a.message_id;try{b.func(a.data)}catch(d){c=d,console.log("MESSAGE BUS FAIL: callback "+b.channel+" caused exception "+c.message)}}return"/__status"===a.channel&&void 0!==a.data[b.channel]?b.last_id=a.data[b.channel]:void 0})}),b):!1},k=function(d,e){var f,g,h;return g=!1,f=!1,j=new Date,l.totalAjaxCalls+=1,h=l.baseUrl+"message-bus/"+l.clientId+"/poll?"+(o()&&l.enableLongPolling?"":"dlp=t"),a.post(h,b(e),l.httpParams).success(function(a,b,c,d){return l.failCount=0,l.paused?a?l.later.push(a):void 0:g=n(a)}).error(function(a,b,c,d){return 0===b?f=!0:(l.failCount+=1,l.totalAjaxFailures+=1)})["finally"](function(){var a;return a=void 0,g||f?a=100:(a=l.callbackInterval,l.failCount>2?a*=l.failCount:o()||(a=l.backgroundCallbackInterval),a>l.maxPollInterval&&(a=l.maxPollInterval),a-=new Date-j,100>a&&(a=100)),m=c(function(){return m=null,d()},a),l.longPoll=null})},l={alwaysLongPoll:!1,baseUrl:"/",callbackInterval:15e3,callbacks:[],clientId:p(),enableLongPolling:!0,failCount:0,later:[],maxPollInterval:18e4,paused:!1,totalAjaxCalls:0,totalAjaxFailures:0,backgroundCallbackInterval:6e4,httpParams:{timeout:f.promise,headers:{"Content-Type":"application/x-www-form-urlencoded","X-SILENCE-LOGGER":"true"},cache:!1},diagnostics:function(){return console.log("Stopped: "+l.stopped+" Started: "+l.started),console.log("Current callbacks"),console.log(l.callbacks),console.log("Total ajax calls: "+l.totalAjaxCalls+" Recent failure count: "+l.failCount+" Total failures: "+l.totalAjaxFailures),console.log("Last ajax call: "+(new Date-j)/1e3+" seconds ago")},pause:function(){l.paused=!0},resume:function(){for(l.paused=!1;l.later.length;)n(l.later.pop())},stop:function(){l.stopped=!0,l.started=!1},start:function(a){var b,e,f;return null==a&&(a={}),angular.forEach(a,function(a,b){return"object"==typeof l[b]?angular.extend(l[b],a):"undefined"!=typeof l[b]?l[b]=a:void 0}),b=void 0,l.started?void 0:(l.started=!0,l.stopped=!1,e=function(){var a;if(!l.stopped)return 0===l.callbacks.length?void(b||(b=c(function(){return b=null,e()},500))):(a={},l.callbacks.forEach(function(b){return a[b.channel]=b.last_id}),l.longPoll=k(e,a))},d.bind("visibilitychange",f=function(){return g[h]||l.longPoll||!m?void 0:(c.cancel(m),m=null,e())}),e())},subscribe:function(a,b,c){return l.started||l.stopped||l.start(),("number"!=typeof c||-1>c)&&(c=-1),l.callbacks.push({channel:a,func:b,last_id:c}),l.longPoll?f.resolve():void 0},unsubscribe:function(a,b){var c;return-1!==a.indexOf("*",a.length-1)&&(a=a.substr(0,a.length-1),c=!0),l.callbacks=l.callbacks.filter(function(d){var e;return e=c?d.channel.substr(0,a.length)!==a:d.channel!==a,!e&&b&&d.func!==b&&(e=!0),e}),l.longPoll?f.resolve():void 0}}}])}).call(this);