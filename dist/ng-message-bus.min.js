/*!Copyright(c) ng-message-bus (//github.com/aptx4869/ng_message_bus) - Licensed under the MIT License */
(function(){"use strict";angular.module("message-bus",[]).factory("MessageBus",["$http","$httpParamSerializerJQLike","$timeout","$document","$q",function(a,b,c,d,e){var f,g,h,i,j,k,l,m,n,o,p,q;return h=d[0],q=function(){return"xxxxxxxxxxxx4xxxyxxxxxxxxxxxxxxx".replace(/[xy]/g,function(a){var b,c;return b=16*Math.random()|0,c="x"===a?b:3&b|8,c.toString(16)})},n=k=i=void 0,g=e.defer()," webkit ms moz ms".split(" ").forEach(function(a){var b;return b=a+(""===a?"hidden":"Hidden"),void 0!==h[b]?i=b:void 0}),j=function(){return void 0!==i?h[i]:!h.hasFocus},p=function(){return m.alwaysLongPoll||!j()},o=function(a){var b;return b=!1,a?(angular.forEach(a,function(a){return b=!0,angular.forEach(m.callbacks,function(b){var c;if(b.channel===a.channel){b.last_id=a.message_id;try{b.func(a.data)}catch(d){c=d,console.log("MESSAGE BUS FAIL: callback "+b.channel+" caused exception "+c.message)}}return"/__status"===a.channel&&void 0!==a.data[b.channel]?b.last_id=a.data[b.channel]:void 0})}),b):!1},l=function(d,e){var f,g,h;return g=!1,f=!1,k=new Date,m.totalAjaxCalls+=1,h=m.baseUrl+"message-bus/"+m.clientId+"/poll?"+(p()&&m.enableLongPolling?"":"dlp=t"),a.post(h,b(e),m.httpParams).success(function(a,b,c,d){return m.failCount=0,m.paused?a?m.later.push(a):void 0:g=o(a)}).error(function(a,b,c,d){return 0===b?f=!0:(m.failCount+=1,m.totalAjaxFailures+=1)})["finally"](function(){var a;return a=void 0,g||f?a=100:(a=m.callbackInterval,m.failCount>2?a*=m.failCount:p()||(a=m.backgroundCallbackInterval),a>m.maxPollInterval&&(a=m.maxPollInterval),a-=new Date-k,100>a&&(a=100)),n=c(function(){return n=null,d()},a),m.longPoll=null})},f=function(){return g.resolve(),g=e.defer(),m.httpParams.timeout=g.promise},m={alwaysLongPoll:!1,baseUrl:"/",callbackInterval:15e3,callbacks:[],clientId:q(),enableLongPolling:!0,failCount:0,later:[],maxPollInterval:18e4,paused:!1,totalAjaxCalls:0,totalAjaxFailures:0,backgroundCallbackInterval:6e4,httpParams:{timeout:g.promise,headers:{"Content-Type":"application/x-www-form-urlencoded","X-SILENCE-LOGGER":"true"},cache:!1},diagnostics:function(){return console.log("Stopped: "+m.stopped+" Started: "+m.started),console.log("Current callbacks"),console.log(m.callbacks),console.log("Total ajax calls: "+m.totalAjaxCalls+" Recent failure count: "+m.failCount+" Total failures: "+m.totalAjaxFailures),console.log("Last ajax call: "+(new Date-k)/1e3+" seconds ago")},pause:function(){m.paused=!0},resume:function(){for(m.paused=!1;m.later.length;)o(m.later.pop())},stop:function(){m.stopped=!0,m.started=!1},start:function(a){var b,e,f;return null==a&&(a={}),angular.forEach(a,function(a,b){return"object"==typeof m[b]?angular.extend(m[b],a):"undefined"!=typeof m[b]?m[b]=a:void 0}),b=void 0,m.started?void 0:(m.started=!0,m.stopped=!1,e=function(){var a;if(!m.stopped)return 0===m.callbacks.length?void(b||(b=c(function(){return b=null,e()},500))):(a={},m.callbacks.forEach(function(b){return a[b.channel]=b.last_id}),m.longPoll=l(e,a))},d.bind("visibilitychange",f=function(){return h[i]||m.longPoll||!n?void 0:(c.cancel(n),n=null,e())}),e())},subscribe:function(a,b,c){var d;return m.started||m.stopped||m.start(),("number"!=typeof c||-1>c)&&(c=-1),m.callbacks.push(d={channel:a,func:b,last_id:c}),m.longPoll&&f(),d},unsubscribe:function(a,b){var c;return-1!==a.indexOf("*",a.length-1)&&(a=a.substr(0,a.length-1),c=!0),m.callbacks=m.callbacks.filter(function(d){var e;return e=c?d.channel.substr(0,a.length)!==a:d.channel!==a,!e&&b&&d.func!==b&&(e=!0),e}),m.longPoll?f():void 0}}}])}).call(this);